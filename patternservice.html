<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-02-05T20:31:10.359655127"><title>Pattern Services | Fantasy-Chess Documentation</title><script type="application/json" id="virtual-toc-data">[{"id":"creation","level":0,"title":"Creation","anchor":"#creation"},{"id":"usage","level":0,"title":"Usage","anchor":"#usage"},{"id":"reversal","level":0,"title":"Reversal","anchor":"#reversal"},{"id":"validations","level":0,"title":"Validations","anchor":"#validations"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b575/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Pattern Services | Fantasy-Chess Documentation"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Fantasy-Chess Documentation Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/patternservice.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Pattern Services | Fantasy-Chess Documentation"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/patternservice.html#webpage",
    "url": "writerside-documentation/patternservice.html",
    "name": "Pattern Services | Fantasy-Chess Documentation",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Fantasy-Chess Documentation Help"
}</script><!-- End Schema.org --></head><body data-id="PatternService" data-main-title="Pattern Services" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Technical Reference///Common///Services"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Fantasy-Chess Documentation  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="PatternService" id="PatternService.md">Pattern Services</h1><p id="f0fr44_3">Pattern Services wrap a <a href="patternmodel.html" id="f0fr44_9" data-tooltip="A pattern model stores the unique name, a String representation of a Pattern and the subpattern-mappings to decode it (char -&gt; pattern name). It comes with getters for all fields.">Pattern Model</a> and provide methods to manipulate and retrieve information about the <a href="patterns.html" id="f0fr44_10" data-tooltip="Patterns are used to define the valid target positions and effected areas of both movement and attack commands. They are defined using Pattern Models.">Pattern</a>. A pattern service holds its underlying <a href="patternmodel.html" id="f0fr44_11" data-tooltip="A pattern model stores the unique name, a String representation of a Pattern and the subpattern-mappings to decode it (char -&gt; pattern name). It comes with getters for all fields.">Pattern Model</a>, a reference to the <a href="patternstore.html" id="f0fr44_12" data-tooltip="Pattern Stores are used to store and provide all .">Pattern Store</a> and two Maps, one mapping from relative position to <code class="code" id="f0fr44_13">char</code> and one mappings from relative position to effected positions. They are created directly by the client or server and are never send over the network.</p><p id="f0fr44_4">Their main task is to provide target positions and positions effected by commands on target positions.</p><section class="chapter"><h2 id="creation" data-toc="creation">Creation</h2><p id="f0fr44_14">Pattern Services are created from a <a href="patternmodel.html" id="f0fr44_23" data-tooltip="A pattern model stores the unique name, a String representation of a Pattern and the subpattern-mappings to decode it (char -&gt; pattern name). It comes with getters for all fields.">Pattern Model</a> and a <a href="patternstore.html" id="f0fr44_24" data-tooltip="Pattern Stores are used to store and provide all .">Pattern Store</a>:</p><div class="code-block" data-lang="java">
    public PatternService(PatternModel patternModel, PatternStore patternStore) 
        throws PatternShapeInvalidException, InvalidSubpatternMappingException {
            this.patternStore = patternStore;
            this.patternModel = patternModel;
            validatePattern(patternModel);
            relativeTargetMappings = createMappingsFromPattern(patternModel);
    
            attackAreasPerRelativePosition = new HashMap&lt;&gt;();
            for (Vector2D target : relativeTargetMappings.keySet()) {
                attackAreasPerRelativePosition
                    .put(target,calculateAreaOfEffect(target));
            }
    }
</div><p id="f0fr44_16">When constructed like this, they are directly validated for possible ambiguity due to pattern shape or errors in the subpattern-mappings. If nothing arises from these checks, the two maps are calculated and saved.</p><p id="f0fr44_17">Pattern Services can also be created directly using components, which is important for <a href="#reversal" id="f0fr44_25" data-tooltip="The server has to transform all coordinates for one player to be able to process their commands. This includes the patterns of their characters. Pattern services provide a method to create a new pattern service that holds the same pattern in reverse.">reversal</a>:</p><div class="code-block" data-lang="java">
    private PatternService(
            PatternModel patternModel, PatternStore patternStore,
            Map&lt;Vector2D, Character&gt; relativeTargetMappings,
            Map&lt;Vector2D, Vector2D[]&gt; attackAreasPerRelativePosition
        ) {
        this.patternStore = patternStore;
        this.patternModel = patternModel;
        this.relativeTargetMappings = relativeTargetMappings;
        this.attackAreasPerRelativePosition = attackAreasPerRelativePosition;
    }
</div><p id="f0fr44_19">Method to calculate mappings from relative position to <code class="code" id="f0fr44_26">char</code>:</p><div class="code-block" data-lang="java">
    private Map&lt;Vector2D,Character&gt; createMappingsFromPattern(
        PatternModel patternModel) {
            String[] lines = patternModel.getPatternString().split(&quot;\n&quot;);
    
            Map&lt;Vector2D,Character&gt; mappings = new HashMap&lt;&gt;();
            for (int y = 0; y &lt; lines.length; y++) {
                String line = lines[y];
                for (int x = 0; x &lt; lines.length; x++) {
                    char tileChar = line.charAt(x);
                    if (tileChar != ' '){
                        mappings.put(
                            new Vector2D(x-lines.length/2, y-lines.length/2), 
                            tileChar
                        );
                    }
                }
            }
            return mappings;
    }
</div><p id="f0fr44_21">Methods to calculate effected areas:</p><div class="code-block" data-lang="java">
    private Vector2D[] calculateAreaOfEffect(Vector2D targetPosition){
        char c = relativeTargetMappings.get(targetPosition);

        Set&lt;Vector2D&gt; targets = new HashSet&lt;&gt;();

        if (patternModel.getSubpatternMappings().containsKey(c)) {
            PatternModel subpatternModel = patternStore
                .getPatternByName(patternModel.getSubpatternMappings().get(c));
            collectTargetsFromSubpattern(subpatternModel,targetPosition,targets);
        } else {
            targets.add(targetPosition);
        }

        return targets.toArray(new Vector2D[0]);
    }
    
    private void collectTargetsFromSubpattern(PatternModel patternModel, 
        Vector2D targetPosition, Set&lt;Vector2D&gt; targets) {
            Map&lt;Vector2D,Character&gt; mappings = createMappingsFromPattern(
                patternModel
            );
            for (Vector2D relativeSubpatternPosition : mappings.keySet()) {
                char c = mappings.get(relativeSubpatternPosition);
                Vector2D subpatternTarget = targetPosition
                    .add(relativeSubpatternPosition);
                if (patternModel.getSubpatternMappings().containsKey(c)) {
                    PatternModel subpatternModel = patternStore
                        .getPatternByName(patternModel
                            .getSubpatternMappings().get(c));
                    collectTargetsFromSubpattern(subpatternModel,
                        subpatternTarget,targets
                    );
                } else {
                    targets.add(subpatternTarget);
                }
            }
    }
</div></section><section class="chapter"><h2 id="usage" data-toc="usage">Usage</h2><p id="f0fr44_27">Use the method &quot;getPossibleTargetPositions&quot; to retrieve all absolute target positions defined by the pattern based on player position:</p><div class="code-block" data-lang="java">
    public Vector2D[] getPossibleTargetPositions(Vector2D player){
        return Arrays.stream(relativeTargetMappings.keySet()
            .toArray(new Vector2D[0])).map(player::add).toArray(Vector2D[]::new);
    }
</div><p id="f0fr44_29">Use the method &quot;getAreaOfEffect&quot; to retrieve a list of all absolute positions effected by a specified command:</p><div class="code-block" data-lang="java">
    public Vector2D[] getAreaOfEffect(Vector2D player, Vector2D targetPosition) {
        Vector2D relativePosition = targetPosition.subtract(player);
        if (!attackAreasPerRelativePosition.containsKey(relativePosition)) {
            return new Vector2D[0];
        }

        Vector2D[] relativePositions = attackAreasPerRelativePosition
            .get(relativePosition);
        return Arrays.stream(relativePositions).map(player::add)
            .toArray(Vector2D[]::new);
    }
</div></section><section class="chapter"><h2 id="reversal" data-toc="reversal">Reversal</h2><p id="f0fr44_31">The server has to transform all coordinates for one player to be able to process their commands. This includes the patterns of their <a href="characterentity.html" id="f0fr44_34" data-tooltip="Character Entities">characters</a>. Pattern services provide a method to create a new pattern service that holds the same <a href="patterns.html" id="f0fr44_35" data-tooltip="Patterns are used to define the valid target positions and effected areas of both movement and attack commands. They are defined using Pattern Models.">pattern</a> in reverse.</p><div class="code-block" data-lang="java">
    public PatternService reversePattern() {
        Map&lt;Vector2D,Vector2D[]&gt; newAttackAreasPerRelativePosition = new HashMap&lt;&gt;();
        Map&lt;Vector2D, Character&gt; newRelativeTargetMappings = new HashMap&lt;&gt;();


        for (Vector2D target : attackAreasPerRelativePosition.keySet()) {

            Vector2D[] oldSubtargets = attackAreasPerRelativePosition
                .get(target);
            Vector2D[] newSubtargets = new Vector2D[oldSubtargets.length];

            for (int i = 0; i &lt; oldSubtargets.length; i++) {
                newSubtargets[i] = reversePosition(oldSubtargets[i]);
            }

            newAttackAreasPerRelativePosition
                .put(reversePosition(target),newSubtargets);
        }

        for (Vector2D target : relativeTargetMappings.keySet()) {
            newRelativeTargetMappings.put(reversePosition(target),
                relativeTargetMappings.get(target)
            );
        }

        return new PatternService(
                patternModel, patternStore, newRelativeTargetMappings,
                newAttackAreasPerRelativePosition
        );
    }
    
    private Vector2D reversePosition(Vector2D position){
        return new Vector2D(-position.getX(),-position.getY());
    }
</div><p id="f0fr44_33">This method effectively turns the pattern including all subpattern-information by 180 degrees.</p></section><section class="chapter"><h2 id="validations" data-toc="validations">Validations</h2><p id="f0fr44_36">Method to validate <a href="patternmodel.html" id="f0fr44_42" data-tooltip="A pattern model stores the unique name, a String representation of a Pattern and the subpattern-mappings to decode it (char -&gt; pattern name). It comes with getters for all fields.">Pattern Model</a> using all validation methods</p><div class="code-block" data-lang="java">
    private void validatePattern(PatternModel patternModel) 
        throws PatternShapeInvalidException, InvalidSubpatternMappingException {
            String[] lines = patternModel.getPatternString().split(&quot;\n&quot;);
    
            if (isPatternShapeInvalid(lines)) {
                throw new PatternShapeInvalidException();
            }
            if (arePatternMappingsInvalid(patternModel)){
                throw new InvalidSubpatternMappingException();
            }
    }
</div><p id="f0fr44_38">Method to validate pattern shape</p><div class="code-block" data-lang="java">
    private boolean isPatternShapeInvalid(String[] lines){
        if (lines.length % 2 == 0){
            return true;
        }
        int length = lines.length;
        for (String line : lines) {
            if (length != line.length()) {
                return true;
            }
        }
        return false;
    }
</div><p id="f0fr44_40">Method to recursively check subpattern-mappings</p><div class="code-block" data-lang="java">
    private boolean arePatternMappingsInvalid(PatternModel patternModel) {
        String[] lines = patternModel.getPatternString().split(&quot;\n&quot;);
        for (String line:lines){
            for (char c : line.toCharArray()){
                if (c == ' '){
                    continue;
                }
                if (!patternModel.getSubpatternMappings().containsKey(c)){
                    continue;
                }
                String subpatternName = patternModel
                    .getSubpatternMappings().get(c);

                PatternModel subpatternModel = patternStore
                    .getPatternByName(subpatternName);
                if (subpatternModel == null){
                    return true;
                }
                return arePatternMappingsInvalid(subpatternModel);
            }
        }
        return false;
    }
</div></section><div class="last-modified">Last modified: 05 February 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="characterstore.html" class="navigation-links__prev">Character Store</a><a href="gridservice.html" class="navigation-links__next">Grid Service</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b575/app.js"></script></body></html>